<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>ì‚ì‚ì˜ ê³¼ì¼ í•©ì¹˜ê¸° ğŸ¾ğŸ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <style>
        body { margin: 0; background: #222; overflow: hidden; font-family: 'Arial', sans-serif; }
        canvas { margin: 0 auto; display: block; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        #orientation { display: none; }
    </style>
    <!-- Phaser 2 CE CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser-ce/2.19.2/phaser.min.js"></script>
</head>
<body>

<script>
// ==========================================
// ê²Œì„ ì„¤ì • ë° ì „ì—­ ë³€ìˆ˜
// ==========================================
var GAME_WIDTH = 600;
var GAME_HEIGHT = 900;

// ê³¼ì¼ ë‹¨ê³„ë³„ ë°˜ì§€ë¦„ (í”½ì…€ ë‹¨ìœ„, ê²Œì„ í¬ê¸°ì— ë§ì¶° ì¡°ì •ë¨)
var FRUIT_RADII = [15, 23, 32, 40, 50, 62, 75, 88, 102, 118, 140];

var game = new Phaser.Game(GAME_WIDTH, GAME_HEIGHT, Phaser.AUTO, '', null);

var score = 0;
var highScore = 0;

// ==========================================
// Boot State: í™”ë©´ ì„¤ì •
// ==========================================
var BootState = {
    preload: function() {
        game.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;
        game.scale.pageAlignHorizontally = true;
        game.scale.pageAlignVertically = true;
        game.stage.backgroundColor = '#fceebb';
    },
    create: function() {
        game.state.start('Preload');
    }
};

// ==========================================
// Preload State: ìì‚° ë¡œë”©
// ==========================================
var PreloadState = {
    preload: function() {
        var loadingText = game.add.text(game.world.centerX, game.world.centerY, "Loading...", { font: "32px Arial", fill: "#000" });
        loadingText.anchor.set(0.5);

        var path = 'assets/';
        game.load.image('background', path + 'background.png');
        game.load.image('splash', path + 'splash.png');
        
        for (var i = 1; i <= 11; i++) {
            game.load.image('fruit' + i, path + 'fruit' + i + '.png');
        }
    },
    create: function() {
        game.state.start('Splash');
    }
};

// ==========================================
// Splash State: íƒ€ì´í‹€ í™”ë©´
// ==========================================
var SplashState = {
    create: function() {
        if (game.cache.checkImageKey('background')) {
            var bg = game.add.image(0, 0, 'background');
            bg.width = game.width; bg.height = game.height;
        }

        if (game.cache.checkImageKey('splash')) {
            var splash = game.add.image(game.world.centerX, game.world.centerY - 50, 'splash');
            splash.anchor.set(0.5);
        } else {
            var titleText = game.add.text(game.world.centerX, game.world.centerY - 50, "ì‚ì‚ì˜ ê³¼ì¼ í•©ì¹˜ê¸°", { font: "50px Arial", fill: "#333", fontWeight: "bold" });
            titleText.anchor.set(0.5);
        }

        var startText = game.add.text(game.world.centerX, game.height - 150, "í™”ë©´ì„ í„°ì¹˜í•˜ì—¬ ì‹œì‘!", { font: "30px Arial", fill: "#e74c3c", fontWeight: "bold" });
        startText.anchor.set(0.5);
        game.add.tween(startText).to({ alpha: 0.5 }, 800, Phaser.Easing.Linear.None, true, 0, -1, true);

        game.input.onDown.addOnce(function() {
            game.state.start('Play');
        }, this);
    }
};

// ==========================================
// Play State: ë©”ì¸ ê²Œì„ ë¡œì§
// ==========================================
var PlayState = {
    create: function() {
        score = 0;
        this.canDrop = true;
        this.isGameOver = false;
        this.dangerTime = 0;
        this.deadlineY = 200;

        game.physics.startSystem(Phaser.Physics.P2JS);
        game.physics.p2.gravity.y = 1200;
        game.physics.p2.restitution = 0.2;
        game.physics.p2.friction = 0.6;

        if (game.cache.checkImageKey('background')) {
            var bg = game.add.image(0, 0, 'background');
            bg.width = game.width; bg.height = game.height;
        }

        this.deadlineLine = game.add.graphics(0, 0);
        this.deadlineLine.lineStyle(4, 0xff0000, 0.5);
        this.deadlineLine.moveTo(0, this.deadlineY);
        this.deadlineLine.lineTo(game.width, this.deadlineY);
        
        this.scoreText = game.add.text(20, 20, "Score: 0", { font: "30px Arial", fill: "#333", fontWeight: "bold" });
        
        this.warningText = game.add.text(game.world.centerX, 100, "WARNING!", { font: "40px Arial", fill: "#ff0000", fontWeight: "bold" });
        this.warningText.anchor.set(0.5);
        this.warningText.visible = false;

        this.fruitsCollisionGroup = game.physics.p2.createCollisionGroup();
        game.physics.p2.updateBoundsCollisionGroup();

        this.fruitsGroup = game.add.group();

        game.input.onDown.add(this.dropFruit, this);
        game.input.addMoveCallback(this.moveCurrentFruit, this);

        this.spawnNextFruit();
    },

    spawnNextFruit: function() {
        if (this.isGameOver) return;
        this.nextLevel = game.rnd.integerInRange(1, 3);
        var key = 'fruit' + this.nextLevel;
        this.currentFruit = game.add.sprite(game.input.x || game.world.centerX, 60, key);
        this.currentFruit.anchor.set(0.5);
        var radius = FRUIT_RADII[this.nextLevel - 1];
        this.currentFruit.width = radius * 2;
        this.currentFruit.height = radius * 2;
        this.canDrop = true;
    },

    moveCurrentFruit: function(pointer, x, y) {
        if (this.canDrop && this.currentFruit) {
            var radius = FRUIT_RADII[this.nextLevel - 1];
            var clampedX = Phaser.Math.clamp(x, radius, game.width - radius);
            this.currentFruit.x = clampedX;
        }
    },

    dropFruit: function() {
        if (!this.canDrop || this.isGameOver) return;
        this.canDrop = false;
        var dropX = this.currentFruit.x;
        var dropY = this.currentFruit.y;
        var level = this.nextLevel;
        this.currentFruit.destroy();
        this.currentFruit = null;
        this.createPhysicsFruit(dropX, dropY, level);
        game.time.events.add(600, this.spawnNextFruit, this);
    },

    createPhysicsFruit: function(x, y, level) {
        if (level > 11) return;
        var key = 'fruit' + level;
        var fruit = this.fruitsGroup.create(x, y, key);
        fruit.fruitLevel = level;
        fruit.anchor.set(0.5);
        var radius = FRUIT_RADII[level - 1];
        fruit.width = radius * 2;
        fruit.height = radius * 2;
        game.physics.p2.enable(fruit);
        fruit.body.setCircle(radius);
        fruit.body.mass = level * 1.5;
        fruit.body.damping = 0.4;
        fruit.body.setCollisionGroup(this.fruitsCollisionGroup);
        fruit.body.collides([this.fruitsCollisionGroup]);
        fruit.body.onBeginContact.add(this.fruitHit, this);
        return fruit;
    },

    fruitHit: function(body, bodyB, shapeA, shapeB, equation) {
        if (!body || !body.sprite) return;
        var otherFruit = body.sprite;
        var myFruit = equation[0].bodyA.parent.sprite;
        if (!myFruit || !otherFruit) return;
        if (myFruit.key !== otherFruit.key) return;
        if (myFruit.pendingDestroy || otherFruit.pendingDestroy) return;
        var level = myFruit.fruitLevel;
        if (level >= 11) return;

        if (myFruit.z > otherFruit.z) {
            var midX = (myFruit.x + otherFruit.x) / 2;
            var midY = (myFruit.y + otherFruit.y) / 2;
            myFruit.pendingDestroy = true;
            otherFruit.pendingDestroy = true;
            var _this = this;
            game.time.events.add(0, function() {
                myFruit.destroy();
                otherFruit.destroy();
                _this.createPhysicsFruit(midX, midY, level + 1);
                score += level * 10;
                _this.scoreText.text = "Score: " + score;
            });
        }
    },

    update: function() {
        if (this.isGameOver) return;
        var danger = false;
        this.fruitsGroup.forEachAlive(function(fruit) {
            if (fruit.y < this.deadlineY) {
                if (Math.abs(fruit.body.velocity.y) < 20 && Math.abs(fruit.body.velocity.x) < 20) {
                    danger = true;
                }
            }
        }, this);

        if (danger) {
            this.dangerTime += game.time.elapsed;
            this.warningText.visible = true;
            this.warningText.alpha = 0.5 + Math.sin(game.time.now / 100) * 0.5;
            if (this.dangerTime > 3000) {
                this.gameOver();
            }
        } else {
            this.dangerTime = 0;
            this.warningText.visible = false;
        }
    },

    gameOver: function() {
        this.isGameOver = true;
        this.warningText.visible = false;
        game.time.events.add(1000, function() {
            game.state.start('GameOver');
        }, this);
    }
};

var GameOverState = {
    create: function() {
        var bg = game.add.graphics(0, 0);
        bg.beginFill(0x000000, 0.8);
        bg.drawRect(0, 0, game.width, game.height);
        bg.endFill();
        var title = game.add.text(game.world.centerX, 200, "GAME OVER", { font: "60px Arial", fill: "#e74c3c", fontWeight: "bold" });
        title.anchor.set(0.5);
        var scoreText = game.add.text(game.world.centerX, 400, score, { font: "60px Arial", fill: "#fff", fontWeight: "bold" });
        scoreText.anchor.set(0.5);
        var restartBtn = game.add.text(game.world.centerX, 600, "ë‹¤ì‹œ ë„ì „í•˜ê¸°", { font: "35px Arial", fill: "#fff", backgroundColor: "#27ae60" });
        restartBtn.anchor.set(0.5);
        restartBtn.padding.set(20, 10);
        restartBtn.inputEnabled = true;
        restartBtn.events.onInputDown.add(function() { game.state.start('Play'); }, this);
    }
};

game.state.add('Boot', BootState);
game.state.add('Preload', PreloadState);
game.state.add('Splash', SplashState);
game.state.add('Play', PlayState);
game.state.add('GameOver', GameOverState);
game.state.start('Boot');
</script>
</body>
</html>
